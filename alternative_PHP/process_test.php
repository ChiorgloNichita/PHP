<?php
/**
 * Обрабатывает результаты прохождения теста.
 * Загружает данные из файла `data.json`, проверяет наличие вопросов и записывает результаты.
 *
 * @file process_test.php
 */

// Путь к файлу с данными
$dataFile = "data.json";

/**
 * Проверка существования файла и загрузка данных.
 * Если файл не найден, выводится ошибка и выполнение прерывается.
 */
if (!file_exists($dataFile)) {
    echo "Файл данных не найден.";
    exit;
}

// Загружаем данные из файла и преобразуем их в ассоциативный массив
$data = json_decode(file_get_contents($dataFile), true);

/**
 * Массив вопросов из данных
 * Если массив пустой, то тест не может быть проведён.
 * 
 * @var array $questions Массив вопросов для теста.
 */
$questions = $data["questions"] ?? [];

/**
 * Проверка наличия вопросов для теста.
 * Если вопросов нет, выводим сообщение и прекращаем выполнение.
 */
if (empty($questions)) {
    echo "Нет вопросов для теста.";
    exit;
}

/**
 * Обработка POST-запроса при отправке формы с результатами теста.
 * Подсчитываются правильные ответы, и результаты сохраняются в файл.
 */
if ($_SERVER["REQUEST_METHOD"] === "POST") {
    /**
     * Получаем имя пользователя.
     * Проверяется наличие имени пользователя, если оно не введено — выводится ошибка.
     * 
     * @var string $username Имя пользователя, введённое в форме.
     */
    $username = $_POST["username"] ?? '';

    // Валидация: проверяем, что имя пользователя не пустое
    if (empty($username)) {
        echo "Пожалуйста, введите ваше имя.";
        exit;
    }

    /**
     * Получаем ответы пользователя.
     * Массив ответов может быть пустым, если пользователь не выбрал варианты.
     * 
     * @var array $userAnswers Массив ответов пользователя.
     */
    $userAnswers = $_POST["answer"] ?? [];

    /**
     * Подсчёт правильных ответов.
     * Сравниваются ответы пользователя с правильными и увеличивается счётчик правильных ответов.
     * 
     * @var int $correctCount Количество правильных ответов пользователя.
     */
    $correctCount = 0;

    /**
     * Проходим по каждому вопросу и проверяем правильность ответа.
     * Если ответ пользователя совпадает с правильным, увеличиваем счетчик.
     */
    foreach ($questions as $index => $q) {
        $correct = $q["correct"];
        $userResponse = $userAnswers[$index] ?? [];

        if ($correct == $userResponse) {
            $correctCount++;
        }
    }

    /**
     * Открытие файла с результатами для записи.
     * Если файл существует, загружаем результаты. Если нет — создаём новый массив.
     * 
     * @var string $resultFile Путь к файлу с результатами.
     * @var array $results Массив всех сохранённых результатов тестов.
     */
    $resultFile = 'results.json';
    $results = file_exists($resultFile) ? json_decode(file_get_contents($resultFile), true) : [];

    /**
     * Добавляем новый результат в массив.
     * Включает имя пользователя, количество правильных ответов.
     */
    $results[] = [
        'username' => $username,
        'correct_answers' => $correctCount,
    ];

    /**
     * Сохраняем обновлённый массив результатов в файл.
     * Результаты сохраняются в формате JSON с красивым выводом.
     */
    file_put_contents($resultFile, json_encode($results, JSON_PRETTY_PRINT));

    /**
     * Перенаправление на страницу с результатами.
     * Передаем количество правильных ответов в URL для отображения результатов.
     */
    header("Location: result.php?correct=$correctCount");
    exit;
}
